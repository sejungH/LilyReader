<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Chiron+GoRound+TC:wght@200..900&display=swap">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda@3.4.3/eruda.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GP8PTD3TLS"></script>
    <script async src="https://accounts.google.com/gsi/client" defer></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-GP8PTD3TLS');
    </script>

    <script src="./scripts/firebaseDB.js"></script>
    <script src="./scripts/googleScript.js"></script>
    <script src="./scripts/googleAuth.js"></script>
    <script src="./scripts/seriesController.js"></script>
    <script src="./scripts/functions.js"></script>

    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico">
    <meta property="og:image" content="https://www.lilyreader.online/icons/icon.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1024">
    <meta property="og:image:height" content="1024">
    <meta property="og:title" content="LILY READER">
    <meta property="og:description" content="대세는 백합 갤번역 리더기 by.LILYD3V">
    <title>LilyReader</title>

    <style>
        body {
            font-family: "Chiron GoRound TC", sans-serif;
        }

        input,
        textarea,
        select {
            touch-action: manipulation;
        }
    </style>
</head>

<body class="d-flex flex-column min-vh-100" data-bs-theme="dark">
    <nav class="navbar navbar-expand-md bg-primary-subtle">
        <div class="container-md">
            <a class="navbar-brand" href="./"><i class="bi bi-book-fill fs-3 me-2"></i><span class="fs-3"
                    style="font-family: 'Bebas Neue', sans-serif;">Lily Reader</span></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse mt-2 mt-md-0" id="navbarSupportedContent">
                <form class="ms-auto" role="search" onsubmit="return false;">
                    <div class="d-flex dropdown position-relative">
                        <input class="form-control" type="search" placeholder="검색" aria-label="Search"
                            autocomplete="off" oninput="showSuggestions(this.value)" size="40" />
                        <ul class="dropdown-menu dropdown-menu-dark w-100" id="autocomplete-list"
                            style="max-height: 200px; overflow-y: auto; margin-top: 2.5rem;"></ul>
                    </div>
                </form>
                <div id="login_container" class="mt-2 mt-md-0 ms-0 ms-md-3" style="color-scheme: light"></div>
            </div>
        </div>
    </nav>

    <div id="main-container" class="container-md mb-4">
        <div class="d-flex border-bottom py-2 mb-3">
            <div id="tags" class="d-flex gap-1 overflow-x-auto me-3"></div>
            <button class="btn btn-sm btn-primary text-nowrap ms-auto" onclick="addNewSeries()"><i
                    class="bi bi-plus-circle-fill"></i> 새 시리즈 추가</button>
        </div>
        <div class="d-flex my-3">
            <button id="current-sort" class="btn btn-sm btn-outline-light dropdown-toggle" type="button"
                data-bs-toggle="dropdown" aria-expanded="false">정렬</button>
            <ul class="dropdown-menu" id="sortby">
                <li>
                    <button class="dropdown-item" type="button" onclick="sortSeries('datetime', true); reloadSeries();"
                        data-sortby="datetime-asc">
                        <small>최근 업데이트 <i class="bi bi-sort-down-alt"></i></small>
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" type="button" onclick="sortSeries('datetime', false); reloadSeries();"
                        data-sortby="datetime-desc">
                        <small>최근 업데이트 <i class="bi bi-sort-down"></i></small>
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" type="button" onclick="sortSeries('abc', true); reloadSeries();"
                        data-sortby="abc-asc">
                        <small>가나다 <i class="bi bi-sort-down-alt"></i></small>
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" type="button" onclick="sortSeries('abc', false); reloadSeries();"
                        data-sortby="abc-desc">
                        <small>가나다 <i class="bi bi-sort-down"></i></small>
                    </button>
                </li>
            </ul>
            <div id="view-radio" class="btn-group btn-group-sm ms-auto" role="group" aria-label="Basic radio toggle button group">
                <input type="radio" class="btn-check" name="btnradio" id="btnlist" autocomplete="off" onchange="if(this.checked) {currView('list')}" checked>
                <label class="btn btn-outline-light" for="btnlist"><i class="bi bi-view-stacked"></i></label>
                <input type="radio" class="btn-check" name="btnradio" id="btngrid" autocomplete="off" onchange="if(this.checked) {currView('grid')}">
                <label class="btn btn-outline-light" for="btngrid"><i class="bi bi-grid"></i></label>
            </div>
        </div>
        <div class="accordion my-3" id="series-list"></div>
    </div>

    <div class="modal fade" id="newSeriesModal" tabindex="-1" aria-labelledby="newSeriesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="newSeriesModalLabel">새 시리즈</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form onsubmit="saveNewSeries(); return false;">
                    <div class="modal-body row">
                        <div class="col-md-3 text-center">
                            <img src="./images/cover_placeholder.png" alt="Cover Image"
                                class="img-fluid mx-auto rounded shadow" id="cover-preview"
                                style="max-width: 100%; aspect-ratio: 2 / 3; object-fit: cover;" />
                        </div>
                        <div class="col-md-9 mt-3 mt-md-0">
                            <p class="mb-2">시리즈</p>
                            <div class="input-group input-group-sm mb-3">
                                <span class="input-group-text">제목</span>
                                <input type="text" id="input-series-title" class="form-control" placeholder="시리즈 제목"
                                    required />
                            </div>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                                <input type="url" id="input-series-cover" class="form-control" placeholder="커버 이미지 URL"
                                    onchange="previewCoverImage(this, 'cover-preview')" />
                            </div>
                            <p class="mt-4 mb-2">태그</p>
                            <div id="new-tags" class="d-flex flex-wrap align-items-center gap-1 my-2 series-tags">
                                <div class="dropdown d-inline-block">
                                    <button type="button"
                                        class="btn btn-outline-light badge rounded-pill dropdown-toggle"
                                        data-bs-toggle="dropdown" aria-expanded="false">+ 태그 추가</button>
                                    <ul class="dropdown-menu" id="tags-dropdown"></ul>
                                </div>
                                <div id="new-tags" class="d-flex gap-1 flex-wrap"></div>
                            </div>
                            <p class="mt-4 mb-2">에피소드 목록</p>
                            <div class="list-group list-group-flush" id="episode-list"></div>
                            <div class="d-flex justify-content-center gap-2">
                                <button type="button" class="btn btn-sm btn-success mt-2"
                                    onclick="newEpisode('new-series')"><i class="bi bi-plus-circle-fill"></i> 에피소드
                                    추가</button>
                                <button type="button" class="btn btn-sm btn-primary mt-2"
                                    onclick="newSeries('new-series')"><i class="bi bi-plus-circle-fill"></i> 시리즈로 추가</button>
                                <button type="button" class="btn btn-sm btn-light mt-2"
                                    onclick="newHorizontalLine('new-series')"><i class="bi bi-plus-circle-fill"></i> 구분선
                                    추가</button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="submit" id="save-new-series" class="btn btn-primary">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer class="bg-secondary-subtle mt-auto">
        <div class="container-md py-4 text-center">
            <p class="text-muted mb-2">&copy; 2025 Lily Reader</p>
            <a href="mailto:lilyd3v@gmail.com" class="text-secondary"><small>버그 및 오류 제보</small></a>
        </div>
    </footer>

    <div id="spinner" class="bg-dark bg-opacity-50 position-fixed top-0 bottom-0 start-0 end-0 z-5">
        <div class="position-absolute top-50 start-50 translate-middle z-3">
            <div class="d-flex justify-content-center my-3">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('dev') && urlParams.get('dev') === 'true') {
            eruda.init();
        }

        const firebaseDB = new FirebaseDB();
        var seriesList = [];
        var user = null;

        init();

        async function init() {
            user = await initUser();
            initGoogleAuth();

            loadView();
            loadTags();
            document.getElementById('series-list').innerHTML = '';
            const data = await firebaseDB.readData();
            hideSpinner();
            seriesList = [];
            data.forEach(d => {
                seriesList.push(convertSeries(d));
            });
            sortSeries('datetime', false);

            for (const series of seriesList) {
                loadSeries(series);
            }

            new Sortable(document.getElementById(`episode-list`), {
                handle: '.handle',
                animation: 150,
                ghostClass: 'blue-background-class',
            });
        }

        function addNewSeries() {
            document.getElementById('episode-list').innerHTML = '';
            newEpisode("new-series");
            document.getElementById('input-series-title').value = '';
            document.getElementById('input-series-cover').value = '';

            document.getElementById('cover-preview').src = './images/cover_placeholder.png';

            document.getElementById('new-tags').querySelectorAll('span.badge').forEach(badge => badge.remove());
            document.getElementById('tags-dropdown').innerHTML = '';
            for (const tag of TAGS) {
                document.getElementById('tags-dropdown').innerHTML +=
                    `<li>
                    <button type="button" class="dropdown-item" onclick="javascript:addTag(this)">
                        <small>${tag}</small>
                    </button>
                </li>`;
            }

            const newSeriesModal = document.getElementById('newSeriesModal');
            let modal = bootstrap.Modal.getInstance(newSeriesModal);
            if (!modal) {
                modal = new bootstrap.Modal(newSeriesModal);
            }
            modal.show();
        }

        async function saveNewSeries() {
            const newSeriesModal = document.getElementById('newSeriesModal');
            let modal = bootstrap.Modal.getInstance(newSeriesModal);
            if (!modal) {
                modal = new bootstrap.Modal(newSeriesModal);
            }
            modal.hide();

            showSpinner();
            var title = document.getElementById('input-series-title').value;
            var cover = document.getElementById('cover-preview').src;

            var tags = [];
            document.getElementById('new-tags').querySelectorAll('span.badge').forEach(badge => {
                tags.push(badge.textContent.trim());
            });

            var countlines = 0;
            var newEpisodes = [];
            for (var ep of document.getElementById('episode-list').querySelectorAll('input')) {
                if (ep.type == 'url') {
                    let json = JSON.parse(ep.getAttribute('data-episode'));
                    newEpisodes.push({ id: json.id, title: json.title, datetime: new Date(json.datetime) });
                } else if (ep.type == 'text') {
                    let title = DOMPurify.sanitize(ep.value);
                    countlines--;
                    newEpisodes.push({ id: countlines, title: title, datetime: new Date() });
                }
            }

            var seriesId = await firebaseDB.writeData({ title: DOMPurify.sanitize(title), cover: cover, tags: tags, episodes: newEpisodes });

            if (seriesId) {
                hideSpinner();
                await init();

                const bsCollapse = new bootstrap.Collapse(`#flush-collapse-${seriesId}`, {
                    toggle: false
                });
                bsCollapse.show();

                setTimeout(() => {
                    document.getElementById(`series-${seriesId}`).scrollIntoView({ behavior: "smooth", block: "start" });
                }, 300);
            }
        }

    </script>

</body>

</html>