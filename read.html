<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GP8PTD3TLS"></script>
    <script async src="https://accounts.google.com/gsi/client" defer></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-GP8PTD3TLS');
    </script>

    <script src="./scripts/firebaseDB.js"></script>
    <script src="./scripts/googleScript.js"></script>
    <script src="./scripts/googleAuth.js"></script>
    <script src="./scripts/seriesController.js"></script>
    <script src="./scripts/functions.js"></script>

    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico">
    <meta property="og:image" content="https://www.lilyreader.online/icons/icon.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1024">
    <meta property="og:image:height" content="1024">
    <meta property="og:title" content="LILY READER">
    <meta property="og:description" content="대세는 백합 갤번역 리더기 by.LILYD3V">
    <title>LilyReader</title>

    <style>
        @font-face {
            font-family: 'RIDIBatang';
            src: url('./fonts/RIDIBatang.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        #episode-title,
        #episode-content {
            font-family: 'RIDIBatang', sans-serif;
        }

        #episode-content {
            text-indent: 1rem;
        }

        #episode-content p:has(img) {
            text-indent: 0;
        }

        @media (max-width: 768px) {
            #episode-content div:has(img) {
                width: 100%;
                margin: auto -1rem;
            }

            #episode-content img {
                width: calc(100% + 2rem);
                margin: auto -1rem;
                cursor: pointer;
            }

            #manga-title {
                font-size: 0.8rem;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }

        /* PC: 이미지 가운데 정렬 */
        @media (min-width: 769px) {
            #episode-content img {
                width: auto;
                max-width: 100%;
                margin: auto auto;
                display: block;
                cursor: pointer;
            }

            #manga-title {
                font-size: 1rem;
            }
        }

        #episode-content iframe,
        #episode-content embed {
            aspect-ratio: 16 / 9;
            width: 100%;
            height: 100%;
        }

        input,
        textarea,
        select,
        button {
            touch-action: manipulation;
        }

        .icon {
            width: 1.5rem;
            height: 1.5rem;
        }

        #input-font-size,
        #input-line-height,
        #input-paragraph-margin {
            width: 2rem;
            font-size: 0.8rem;
            padding-left: 0;
            padding-right: 0;
        }

        #manga-container img {
            min-width: 50%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
        }

        #manga-view img[src=""] {
            opacity: 0;
        }
    </style>
</head>

<body class="d-flex flex-column min-vh-100" data-bs-theme="dark">
    <nav class="navbar navbar-expand-md bg-primary-subtle">
        <div class="container-md">
            <a class="navbar-brand" href="./"><i class="bi bi-book-fill fs-3 me-2"></i><span class="fs-3"
                    style="font-family: 'Bebas Neue', sans-serif;">Lily Reader</span></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse mt-2 mt-md-0" id="navbarSupportedContent">
                <form class="ms-auto" role="search" onsubmit="return false;">
                    <div class="d-flex dropdown position-relative">
                        <input class="form-control" type="search" placeholder="검색" aria-label="Search"
                            autocomplete="off" oninput="showSuggestions(this.value)" size="40" />
                        <ul class="dropdown-menu dropdown-menu-dark w-100" id="autocomplete-list"
                            style="max-height: 200px; overflow-y: auto; margin-top: 2.5rem;"></ul>
                    </div>
                </form>
                <div id="login_container" class="mt-2 mt-md-0 ms-0 ms-md-3"></div>
            </div>
        </div>
    </nav>

    <div id="main-container" class="container-md mb-4">
        <nav aria-label="breadcrumb" class="mt-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="./">목록</a></li>
                <li class="breadcrumb-item active w-75 text-truncate" aria-current="page" id="breadcrumb-title"></li>
            </ol>
        </nav>
        <div class="accordion my-3" id="series-list"></div>
        <div id="content-container">
            <div class="row justify-content-between py-3 border-bottom">
                <div class="col-auto">
                    <button class="btn btn-sm btn-outline-light rounded-pill px-3 prev-episode"><i
                            class="bi bi-caret-left-fill"></i>
                        이전화</button>
                </div>
                <div class="col-auto text-end">
                    <button class="btn btn-sm btn-outline-light rounded-pill px-3 next-episode">다음화 <i
                            class="bi bi-caret-right-fill"></i></button>
                </div>
            </div>
            <div class="row my-4">
                <h1 id="episode-title" class="h4 fw-bold mb-4"></h1>
                <div class="mb-4">
                    <span class="badge bg-secondary">글쓴이</span> <span id="episode-writer" class="badge me-4"></span>
                    <span class="badge bg-secondary">작성일</span> <span id="episode-date" class="badge"></span>
                </div>
                <div class="d-flex gap-0 gap-md-5 py-2 mb-3 justify-content-center">
                    <div class="d-flex align-items-center">
                        <img src="./icons/font-size.svg" class="icon me-1">
                        <div class="input-group input-group-sm">
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="changeFontSize(-0.1)">-</button>
                            <span id="input-font-size" class="form-control text-center"></span>
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="changeFontSize(0.1)">+</button>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <img src="./icons/line-height.svg" class="icon ms-3 me-1">
                        <div class="input-group input-group-sm">
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="changeLineHeight(-0.1)">-</button>
                            <span id="input-line-height" class="form-control text-center"></span>
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="changeLineHeight(0.1)">+</button>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <img src="./icons/p-margin.svg" class="icon ms-3 me-1">
                        <div class="input-group input-group-sm">
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="changeParagraphMargin(-0.2)">-</button>
                            <span id="input-paragraph-margin" class="form-control text-center"></span>
                            <button type="button" class="btn btn-outline-secondary"
                                onclick="changeParagraphMargin(0.2)">+</button>
                        </div>
                    </div>
                </div>
                <div id="episode-content" class="overflow-x-hidden"></div>
                <div id="manga-container"
                    class="position-absolute overflow-hidden bg-secondary-subtle p-0 z-2 visually-hidden">
                    <div id="manga-view" class="d-flex justify-content-center align-items-center h-100">
                        <img id="manga-image-1" /><img id="manga-image-2" />
                    </div>
                    <div class="position-absolute top-0 bottom-0 start-0" style="width: 30vw" onclick="mangaLeft()">
                    </div>
                    <div class="position-absolute top-0 bottom-0 start-50 translate-middle-x" style="width: 40vw"
                        onclick="toggleMangaToolbar()"></div>
                    <div class="position-absolute top-0 bottom-0 end-0" style="width: 30vw" onclick="mangaRight()">
                    </div>
                    <div class="manga-toolbar d-flex align-items-center position-absolute top-0 w-100 bg-dark p-3 z-5">
                        <span id="manga-title" class="fw-bold"></span>
                        <button id="btn-manga-view" class="btn ms-auto fs-4 py-0"
                            onclick="toggleMangaView(this)"></button>
                        <button id="btn-manga-direction" class="btn ms-2 ms-md-3 fs-4 py-0"
                            onclick="toggleMangaDirection(this)"></button>
                        <button id="btn-manga-start" class="btn ms-2 ms-md-3 fs-4 py-0 d-flex" data-start="12"
                            onclick="toggleMangaStart(this)">
                            <img src="./icons/manga-12.svg" id="icon-manga-start"
                                style="width: 1.8rem; opacity: 0.9;" />
                        </button>
                        <button class="btn ms-2 ms-md-3 fs-4 py-0" onclick="closeMangaView()"><i
                                class="bi bi-x-lg"></i></button>
                    </div>
                    <div class="manga-toolbar position-absolute bottom-0 w-100 z-4">
                        <div class="progress w-100 rounded-0" style="height: 5px;">
                            <div id="manga-progress" class="progress-bar" role="progressbar" aria-valuenow="0"
                                aria-valuemin="0"></div>
                        </div>
                        <div class="d-flex bg-dark p-3">
                            <button id="btn-prev-episode" class="btn btn-sm btn-outline-light rounded-pill px-3"><i
                                    class="bi bi-caret-left-fill"></i>
                                이전화</button>
                            <button id="btn-next-episode"
                                class="btn btn-sm btn-outline-light rounded-pill px-3 ms-auto">다음화 <i
                                    class="bi bi-caret-right-fill"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row justify-content-between pt-3 border-top">
                <div class="col-auto">
                    <button class="btn btn-sm btn-outline-light rounded-pill px-3 prev-episode"><i
                            class="bi bi-caret-left-fill"></i>
                        이전화</button>
                </div>
                <div class="col-auto text-end">
                    <button class="btn btn-sm btn-outline-light rounded-pill px-3 next-episode">다음화 <i
                            class="bi bi-caret-right-fill"></i></button>
                </div>
            </div>
        </div>
        <div id="comment-container" class="mt-4"></div>
    </div>

    <footer class="bg-secondary-subtle mt-auto">
        <div class="container-md py-4 text-center">
            <p class="text-muted mb-2">&copy; 2025 Lily Reader</p>
            <a href="mailto:lilyd3v@gmail.com" class="text-secondary"><small>버그 및 오류 제보</small></a>
        </div>
    </footer>

    <div id="spinner" class="bg-dark bg-opacity-50 position-fixed top-0 bottom-0 start-0 end-0 z-5">
        <div class="position-absolute top-50 start-50 translate-middle z-3">
            <div class="d-flex justify-content-center my-3">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-50 start-50 translate-middle  p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="1000">
            <div class="toast-header">
                <i class="bi bi-book-fill me-2"></i>
                <strong class="me-auto">LILY READER</strong>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('dev') && urlParams.get('dev') == "true") {
            eruda.init();
        }

        const firebaseDB = new FirebaseDB();
        const seriesId = urlParams.get('series');
        const view = urlParams.get('view');
        var episodeId;
        var series;
        var user = null;

        var mangaImages = [];
        var currPage = 0;

        init();

        async function init() {
            user = await initUser();
            initGoogleAuth();

            document.getElementById('series-list').innerHTML = '';
            const data = await firebaseDB.readDataById(seriesId);

            if (data) {
                series = convertSeries(data);

                var filteredEpisodes = series.episodes.filter(ep => ep.id > 0);

                if (urlParams.has('episode')) {
                    episodeId = Number.parseInt(urlParams.get('episode'));
                } else {
                    episodeId = filteredEpisodes.length > 0 ? filteredEpisodes[0].id : null;
                }

                await loadSeries(series);
                document.getElementById('breadcrumb-title').innerText = series.title;

                const episode = filteredEpisodes.find(ep => ep.id === episodeId);
                if (episode) {
                    for (let td of document.getElementById(`table-${seriesId}`).querySelector(`tr[data-id="${episodeId}"]`).children) {
                        td.classList.add('bg-primary')
                        td.classList.remove('text-secondary-emphasis');
                    }

                    if (document.getElementById('episode-content').innerHTML == "") {
                        const content = await getContent(episodeId);
                        document.querySelector('title').innerText = `${episode.title} | Lily Reader`;
                        document.getElementById('episode-title').innerHTML = `${episode.title} <a href='${getURL(episodeId)}' target='_blank'><i class="bi bi-link-45deg"></i></a>`;
                        document.getElementById('episode-content').innerHTML = content.content;
                        document.getElementById('episode-writer').innerText = content.writer;
                        document.getElementById('episode-date').innerText = new Date(episode.datetime).toLocaleString();

                        if (content.comments.length > 0) {
                            document.getElementById('comment-container').innerHTML = `<span class='fw-bold my-2'>전체 댓글 ${content.comments.length}개</span>`;
                        }
                        content.comments.forEach(comment => {
                            const commentDiv = document.createElement('div');
                            if (comment.type === 'reply') {
                                commentDiv.className = 'card my-2 ms-4 bg-secondary-subtle';
                            } else {
                                commentDiv.className = 'card my-2';
                            }
                            commentDiv.innerHTML = `
                            <div class="card-body">
                                <span class="fw-bold">${comment.nickname}</span>
                                <p id="comment-${comment.id}" class="card-text py-2"></p>
                                <footer class="blockquote-footer mb-0">${comment.datetime}</footer>
                            </div>
                        `;
                            document.getElementById('comment-container').appendChild(commentDiv);
                            loadDcCon(comment.id, comment.comment);
                        });
                    }


                    for (let btn of document.getElementsByClassName('prev-episode')) {
                        const episodeIndex = filteredEpisodes.findIndex(ep => ep.id === episodeId);

                        if (episodeIndex > 0) {
                            const prevEpisode = filteredEpisodes[episodeIndex - 1];
                            btn.addEventListener('click', () => {
                                window.location.href = `read.html?series=${seriesId}&episode=${prevEpisode.id}`;
                            });
                        } else {
                            btn.classList.add('disabled');
                        }

                    }

                    for (let btn of document.getElementsByClassName('next-episode')) {
                        const episodeIndex = filteredEpisodes.findIndex(ep => ep.id === episodeId);
                        if (episodeIndex < filteredEpisodes.length - 1) {
                            const nextEpisode = filteredEpisodes[episodeIndex + 1];
                            btn.addEventListener('click', () => {
                                window.location.href = `read.html?series=${seriesId}&episode=${nextEpisode.id}`;
                            });
                        } else {
                            btn.classList.add('disabled');
                        }

                    }

                    if (user && (!user.viewed || !user.viewed[seriesId] || !user.viewed[seriesId].includes(episodeId))) {
                        await firebaseDB.addViewed(user.id, seriesId, episodeId);
                    }

                    setParagraphStyle();

                    document.getElementById('episode-content').querySelectorAll('img').forEach((img, index) => {
                        img.id = `image-${index}`;
                        img.addEventListener('click', () => {
                            currPage = index;
                            openMangaView();
                        });
                        mangaImages.push(img.src);
                    });

                    if (view && view === "manga" && mangaImages.length > 0) {
                        openMangaView();
                    }

                } else {
                    document.querySelector('#content-container').innerHTML = `
                    <div class="w-100 text-center text-secondary my-5">
                        에피소드를 찾을 수 없습니다
                    </div>`;
                }

            } else {
                displayError(404, '해당 시리즈를 찾을 수 없습니다');
            }

            hideSpinner();
        }

        function setParagraphStyle() {
            const fontSize = localStorage.getItem('fontSize') || '1';
            const lineHeight = localStorage.getItem('lineHeight') || '2';
            const paragraphMargin = localStorage.getItem('paragraphMargin') || '1';

            document.getElementById('input-font-size').innerText = fontSize;
            document.getElementById('input-line-height').innerText = lineHeight;
            document.getElementById('input-paragraph-margin').innerText = paragraphMargin;

            document.getElementById('episode-content').querySelectorAll('*').forEach(el => {
                if (!el.closest('.og-div') && el.textContent.trim()) {
                    el.style.fontSize = fontSize + 'rem';
                    el.style.lineHeight = lineHeight + 'rem';
                    el.style.marginTop = paragraphMargin + 'rem';
                    el.style.marginBottom = paragraphMargin + 'rem';
                }
            });
        }

        function changeFontSize(delta) {
            var input = document.getElementById('input-font-size');
            let value = Math.min(2, Math.max(1, parseFloat(input.innerText) + delta));
            value = Number(value.toFixed(2));
            input.innerText = value;
            var content = document.getElementById('episode-content');
            content.querySelectorAll('*').forEach(el => {
                if (!el.closest('.og-div') && el.textContent.trim()) {
                    el.style.fontSize = value + 'rem';
                }
            });
            localStorage.setItem('fontSize', value);
        }

        function changeLineHeight(delta) {
            var input = document.getElementById('input-line-height');
            let value = Math.min(3, Math.max(1.5, parseFloat(input.innerText) + delta));
            value = Number(value.toFixed(2));
            input.innerText = value;
            var content = document.getElementById('episode-content');
            content.querySelectorAll('*').forEach(el => {
                if (!el.closest('.og-div') && el.textContent.trim()) {
                    el.style.lineHeight = value + 'rem';
                }
            });
            localStorage.setItem('lineHeight', value);
        }

        function changeParagraphMargin(delta) {
            var input = document.getElementById('input-paragraph-margin');
            let value = Math.min(2, Math.max(0, parseFloat(input.innerText) + delta));
            value = Number(value.toFixed(2));
            input.innerText = value;
            var content = document.getElementById('episode-content');
            content.querySelectorAll('*').forEach(el => {
                if (!el.closest('.og-div') && el.textContent.trim()) {
                    el.style.marginTop = value + 'rem';
                    el.style.marginBottom = value + 'rem';
                }
            });
            localStorage.setItem('paragraphMargin', value);
        }

        function openMangaView() {
            document.querySelector('body').classList.add('overflow-hidden');
            const mangaContainer = document.getElementById('manga-container');
            mangaContainer.classList.remove('visually-hidden');
            mangaContainer.addEventListener("touchmove", function (e) {
                e.preventDefault();
            }, { passive: false });
            adjustMangaView();
            window.addEventListener("resize", adjustMangaView);

            document.getElementById('episode-content').classList.add('opacity-0');
            document.getElementById('comment-container').classList.add('opacity-0');

            const mangaView = localStorage.getItem('mangaView') || 'double';
            const mangaDirection = localStorage.getItem('mangaDirection') || 'ltr';
            document.getElementById('btn-manga-view').innerHTML = mangaView === 'single' ? '<i class="bi bi-book-half"></i>' : '<i class="bi bi-book-fill"></i>';
            document.getElementById('btn-manga-direction').innerHTML = mangaDirection === 'ltr' ? '<i class="bi bi-arrow-bar-right"></i>' : '<i class="bi bi-arrow-bar-left"></i>';
            document.getElementById('manga-title').innerText = series.episodes.find(ep => ep.id === episodeId).title;

            if (mangaView === 'single') {
                document.getElementById('manga-image-2').classList.add('d-none');
                document.getElementById('btn-manga-start').classList.add('visually-hidden');
            } else {
                document.getElementById('manga-image-2').classList.remove('d-none');
                document.getElementById('btn-manga-start').classList.remove('visually-hidden');
            }

            if (mangaDirection === 'rtl') {
                document.getElementById('manga-view').classList.add('flex-row-reverse');
                document.getElementById('manga-image-1').style.objectPosition = 'left';
                document.getElementById('manga-image-2').style.objectPosition = 'right';
            } else {
                document.getElementById('manga-view').classList.remove('flex-row-reverse');
                document.getElementById('manga-image-1').style.objectPosition = 'right';
                document.getElementById('manga-image-2').style.objectPosition = 'left';
            }

            document.getElementById('manga-progress').setAttribute('aria-valuemax', mangaImages.length - 1);

            document.addEventListener('keydown', (event) => {
                if (event.key === 'ArrowLeft') {
                    mangaLeft();
                } else if (event.key === 'ArrowRight') {
                    mangaRight();
                } else if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                    event.preventDefault();
                } else if (event.key === 'Escape') {
                    closeMangaView();
                }
            });

            mangaContainer.addEventListener('wheel', (event) => {
                event.preventDefault();
            }, { passive: false });

            var filteredEpisodes = series.episodes.filter(ep => ep.id > 0);
            const episodeIndex = filteredEpisodes.findIndex(ep => ep.id === episodeId);

            if (episodeIndex > 0) {
                const prevEpisode = filteredEpisodes[episodeIndex - 1];
                document.getElementById('btn-prev-episode').addEventListener('click', () => {
                    window.location.href = `read.html?series=${seriesId}&episode=${prevEpisode.id}&view=manga`;
                });
            } else {
                document.getElementById('btn-prev-episode').classList.add('disabled');
            }

            if (episodeIndex < filteredEpisodes.length - 1) {
                const nextEpisode = filteredEpisodes[episodeIndex + 1];
                document.getElementById('btn-next-episode').addEventListener('click', () => {
                    window.location.href = `read.html?series=${seriesId}&episode=${nextEpisode.id}&view=manga`;
                });
            } else {
                document.getElementById('btn-next-episode').classList.add('disabled');
            }

            renderPage();
        }

        function closeMangaView() {
            document.querySelector('body').classList.remove('overflow-hidden');
            document.getElementById('manga-container').classList.add('visually-hidden');
            document.getElementById('episode-content').classList.remove('opacity-0');
            document.getElementById('comment-container').classList.remove('opacity-0');
            window.scrollTo({ top: document.getElementById(`image-${currPage}`).offsetTop - 70, behavior: "instant" });
        }

        function adjustMangaView() {
            const mangaContainer = document.getElementById('manga-container');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile) {
                mangaContainer.style.top = window.scrollY + "px";
            } else {
                mangaContainer.style.top = 0;
                window.scrollTo({ top: 0, behavior: "instant" });
            }
            mangaContainer.style.left = 0;
            mangaContainer.style.height = window.innerHeight + "px";
            mangaContainer.style.width = window.innerWidth + "px";
        }

        function toggleMangaToolbar() {
            document.querySelectorAll('.manga-toolbar').forEach(toolbar => {
                toolbar.classList.toggle('visually-hidden');
            });
        }

        function toggleMangaView(btn) {
            btn.innerHTML = btn.innerHTML.includes('book-half') ? '<i class="bi bi-book-fill"></i>' : '<i class="bi bi-book-half"></i>';
            document.getElementById('manga-image-2').classList.toggle('d-none');
            if (btn.innerHTML.includes('book-fill')) {
                localStorage.setItem('mangaView', 'double');
                document.getElementById('btn-manga-start').classList.remove('visually-hidden');
            } else {
                localStorage.setItem('mangaView', 'single');
                document.getElementById('btn-manga-start').classList.add('visually-hidden');
            }
        }

        function toggleMangaStart(btn) {
            var currStart = btn.getAttribute('data-start');
            if (currStart == "12") {
                btn.setAttribute('data-start', '23');
                document.getElementById('icon-manga-start').src = './icons/manga-23.svg';
                currPage -= 1;
                renderPage();
            } else {
                btn.setAttribute('data-start', '12');
                document.getElementById('icon-manga-start').src = './icons/manga-12.svg';
                currPage += 1;
                renderPage();
            }
        }

        function toggleMangaDirection(btn) {
            btn.innerHTML = btn.innerHTML.includes('arrow-bar-left') ? '<i class="bi bi-arrow-bar-right"></i>' : '<i class="bi bi-arrow-bar-left"></i>';
            document.getElementById('manga-view').classList.toggle('flex-row-reverse');

            if (document.getElementById('manga-view').classList.contains('flex-row-reverse')) {
                localStorage.setItem('mangaDirection', 'rtl');
                document.getElementById('manga-image-1').style.objectPosition = 'left';
                document.getElementById('manga-image-2').style.objectPosition = 'right';
            } else {
                localStorage.setItem('mangaDirection', 'ltr');
                document.getElementById('manga-image-1').style.objectPosition = 'right';
                document.getElementById('manga-image-2').style.objectPosition = 'left';
            }
        }

        function mangaLeft() {
            const mangaDirection = localStorage.getItem('mangaDirection') || 'ltr';
            if (mangaDirection == 'ltr') {
                prevPage(localStorage.getItem('mangaView') || 'double');
            } else {
                nextPage(localStorage.getItem('mangaView') || 'double');
            }
        }

        function mangaRight() {
            const mangaDirection = localStorage.getItem('mangaDirection') || 'ltr';
            if (mangaDirection == 'ltr') {
                nextPage(localStorage.getItem('mangaView') || 'double');
            } else {
                prevPage(localStorage.getItem('mangaView') || 'double');
            }
        }

        function renderPage() {
            const img1 = document.getElementById('manga-image-1');
            const img2 = document.getElementById('manga-image-2');
            img1.src = mangaImages[currPage] || '';
            img2.src = mangaImages[currPage + 1] || '';
            updateProgress();
        }

        function prevPage(view = "double") {
            if (view == "double") {
                if (currPage > 0) {
                    currPage -= 2;
                    renderPage();
                } else {
                    const toast_div = document.getElementById('liveToast');
                    const toastBody = document.querySelector('.toast-body');
                    toastBody.textContent = "첫번째 페이지입니다";
                    const toast = new bootstrap.Toast(toast_div);
                    toast.show();
                }
            } else {
                if (currPage > 0) {
                    currPage--;
                    renderPage();
                } else {
                    const toast_div = document.getElementById('liveToast');
                    const toastBody = document.querySelector('.toast-body');
                    toastBody.textContent = "첫번째 페이지입니다";
                    const toast = new bootstrap.Toast(toast_div);
                    toast.show();
                }
            }
        }

        function nextPage(view = "double") {
            if (view == "double") {
                if (currPage < mangaImages.length - 2) {
                    currPage += 2;
                    renderPage();
                } else {
                    const toast_div = document.getElementById('liveToast');
                    const toastBody = document.querySelector('.toast-body');
                    toastBody.textContent = "마지막 페이지입니다";
                    const toast = new bootstrap.Toast(toast_div);
                    toast.show();
                }
            } else {
                if (currPage < mangaImages.length - 1) {
                    currPage++;
                    renderPage();
                } else {
                    const toast_div = document.getElementById('liveToast');
                    const toastBody = document.querySelector('.toast-body');
                    toastBody.textContent = "마지막 페이지입니다";
                    const toast = new bootstrap.Toast(toast_div);
                    toast.show();
                }
            }
        }

        function updateProgress() {
            const viewMode = localStorage.getItem('mangaView') || 'double';
            const progress = document.getElementById('manga-progress');
            const totalPages = mangaImages.length - 1;
            let percent;
            if (viewMode === 'single') {
                percent = Math.round((currPage / totalPages) * 100);
            } else {
                percent = Math.round(((currPage + 1) / totalPages) * 100);
            }

            progress.setAttribute('aria-valuenow', currPage);
            progress.style.width = percent + "%";   // 👈 실제 막대 움직이는 부분
        }

    </script>
</body>

</html>